<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title data-translate-key="app_title">Typing Speed Challenge V8</title>
    <style>
        /* ==================== */
        /* CSS Styling */
        /* ==================== */
        body {
            font-family: 'Consolas', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #282c34;
            color: #abb2bf;
        }

        #container {
            width: 80%;
            max-width: 900px;
            padding: 40px;
            background-color: #3e4451;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.7);
        }

        /* Optionen / Einstellungsbereich */
        #options-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            border-bottom: 2px solid #61afef;
        }

        .option-group label {
            margin-right: 10px;
            font-size: 1em;
            color: #61afef;
        }

        /* Das Textfeld, das getippt werden muss */
        #text-to-type {
            font-size: 1.6em;
            line-height: 1.6;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #61afef;
            border-radius: 5px;
            background-color: #282c34;
            min-height: 120px;
            white-space: pre-wrap;
            user-select: none;
            /* FIX: Zeilenumbruch-Problem vermeiden */
            overflow-wrap: break-word; 
            word-wrap: break-word;
        }

        /* Hervorhebung f√ºr den aktuellen Buchstaben */
        .current {
            background-color: #c678dd;
            color: #282c34;
            border-radius: 2px;
            padding: 1px 0;
            display: inline-block;
            transform: scale(1.05);
        }

        /* Korrekt getippter Buchstabe */
        .correct {
            color: #98c379;
        }

        /* Falsch getippter Buchstabe */
        .incorrect {
            color: #e06c75;
            text-decoration: underline wavy #e06c75;
        }

        /* Das Eingabefeld */
        #input-field {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: 2px solid #56b6c2;
            border-radius: 5px;
            box-sizing: border-box;
            background-color: #282c34;
            color: #ffffff;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        #input-field:focus {
            border-color: #c678dd;
            outline: none;
        }
        
        /* Status- und Ergebnis-Anzeige */
        #results {
            display: flex;
            justify-content: space-around;
            text-align: center;
            font-size: 1.3em;
            margin-top: 20px;
            padding: 15px 10px;
            border-top: 2px solid #61afef;
            margin-bottom: 20px;
        }
        .stat {
            flex-grow: 1;
        }
        .stat span {
            display: block;
            font-size: 2.2em;
            font-weight: bold;
            color: #e6c07b;
            transition: color 0.3s;
        }

        button {
            background-color: #61afef;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.2em;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        button:hover {
            background-color: #56b6c2;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(1px);
        }

        /* ==================== */
        /* Leaderboard Styling NEU */
        /* ==================== */
        #leaderboard-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #61afef;
        }
        #leaderboard-section h2 {
            text-align: center;
            color: #c678dd;
            margin-bottom: 15px;
        }
        #leaderboard {
            width: 100%;
            border-collapse: collapse;
            font-size: 1em;
        }
        #leaderboard th, #leaderboard td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #4b5263;
        }
        #leaderboard th {
            background-color: #4b5263;
            color: #abb2bf;
            text-transform: uppercase;
            font-size: 0.9em;
        }
        #leaderboard tr:nth-child(odd) {
            background-color: #3e4451;
        }
        #leaderboard tr:hover {
            background-color: #56b6c220;
        }
        .place-1, .place-2, .place-3 {
            font-weight: bold;
            color: #e6c07b; 
        }
        .place-1 td {
            background-color: #e6c07b20;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1 data-translate-key="title">üöÄ Type Challenge</h1>
        
        <div id="options-bar">
            <div class="option-group">
                <label data-translate-key="language_label" for="language">Sprache:</label>
                <select id="language" onchange="loadLanguage(this.value)">
                    <option value="de">Deutsch</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="es">Espa√±ol</option>
                    <option value="it">Italiano</option>
                </select>
            </div>
            
            <div class="option-group">
                <label data-translate-key="category_label" for="difficulty">Textkategorie:</label>
                <select id="difficulty" onchange="startTest()">
                    <option value="short" data-translate-key="category_short">Kurz & Leicht</option>
                    <option value="long" data-translate-key="category_long">Lang & Komplex</option>
                    <option value="tech" data-translate-key="category_tech">Technisch/Code</option>
                </select>
            </div>
            <div id="info-message" style="color: #98c379;" data-translate-key="info_ready">Bereit f√ºr den Start!</div>
        </div>

        <div id="text-to-type"></div>

        <input type="text" id="input-field" data-translate-key="placeholder" placeholder="Beginne hier mit dem Tippen..." autofocus disabled>

        <div id="results">
            <div class="stat" data-translate-key="wpm">WPM<span id="wpm">0</span></div>
            <div class="stat" data-translate-key="accuracy">Genauigkeit<span id="accuracy">0%</span></div>
            <div class="stat" data-translate-key="time">Zeit<span id="time">0.00s</span></div>
        </div>
        
        <button onclick="startTest()" data-translate-key="new_text">Neuer Text / Neustart</button>

        <div id="leaderboard-section">
            <h2 data-translate-key="leaderboard_title">üèÜ Lokale Bestenliste (Top 10)</h2>
            <table id="leaderboard">
                </table>
        </div>

    </div>

    <script>
        /* ==================== */
        /* JavaScript Logic (V8 - Highscore & UX-Fixes) */
        /* ==================== */
        const textToTypeElement = document.getElementById('text-to-type');
        const inputField = document.getElementById('input-field');
        const wpmDisplay = document.getElementById('wpm');
        const accuracyDisplay = document.getElementById('accuracy');
        const timeDisplay = document.getElementById('time');
        const difficultySelect = document.getElementById('difficulty');
        const languageSelect = document.getElementById('language');
        const infoMessage = document.getElementById('info-message');
        const leaderboardTable = document.getElementById('leaderboard'); // NEU

        let currentLang = 'en'; 
        let timer = null; // F√ºr das WPM-Update-Intervall

        // √úbersetzungsobjekt (JSON) - Wichtig: Neuer Key 'leaderboard_title' hinzugef√ºgt!
        const translations = {
            'de': {
                'app_title': 'Tipp-Geschwindigkeits-Trainer',
                'title': 'üöÄ Type Challenge',
                'language_label': 'Sprache:',
                'category_label': 'Textkategorie:',
                'category_short': 'Kurz & Leicht',
                'category_long': 'Lang & Komplex',
                'category_tech': 'Technisch/Code',
                'wpm': 'WPM', 'accuracy': 'Genauigkeit', 'time': 'Zeit',
                'placeholder': 'Beginne hier mit dem Tippen...',
                'new_text': 'Neuer Text / Neustart',
                'info_ready': 'Bereit f√ºr den Start!',
                'info_loaded': (category) => `Text (${category}) geladen.`,
                'info_finished': 'üéâ Test beendet! Dein Score wurde gespeichert.', // Ge√§ndert
                'alert_paste_blocked': '‚ùå Einf√ºgen (Paste) ist im Test nicht erlaubt!',
                'leaderboard_title': 'üèÜ Lokale Bestenliste (Top 10)', // NEU
                'lb_rank': 'Platz', 'lb_wpm': 'WPM', 'lb_acc': 'Genauigkeit', 'lb_diff': 'Kategorie', 'lb_date': 'Datum', // NEU
                'sampleTexts': {
                    short: ["HTML, CSS und JavaScript bilden das Fundament des modernen World Wide Web. HTML f√ºr die Struktur, CSS f√ºr das Design und JavaScript f√ºr die Interaktivit√§t und Logik.", "Die beste Methode, um seine Tippgeschwindigkeit zu verbessern, ist die t√§gliche Konzentration auf genaue Eingaben und das Vermeiden von Fehlern."],
                    long: ["Programmieren lernen ist wie eine neue Sprache zu lernen. Es erfordert Geduld, √úbung und das Verstehen von grundlegenden Regeln, um am Ende komplexe Anwendungen erstellen zu k√∂nnen, welche die Nutzer begeistern sollen.", "Die kontinuierliche Integration und kontinuierliche Bereitstellung sind moderne Softwareentwicklungspraktiken, die darauf abzielen, den Prozess der Freigabe neuer Software-Updates zu beschleunigen."],
                    tech: ["function greet(name) { console.log(`Hello, ${name}!`); } greet('World'); // Die Funktion wird aufgerufen.", "if (x === true && y != 0) { return x / (y * 2); } else { throw new Error('Invalid input'); }"]
                }
            },
            'en': {
                'app_title': 'Typing Speed Trainer',
                'title': 'üöÄ Type Challenge',
                'language_label': 'Language:',
                'category_label': 'Text Category:',
                'category_short': 'Short & Easy',
                'category_long': 'Long & Complex',
                'category_tech': 'Technical/Code',
                'wpm': 'WPM', 'accuracy': 'Accuracy', 'time': 'Time',
                'placeholder': 'Start typing here...',
                'new_text': 'New Text / Restart',
                'info_ready': 'Ready to start!',
                'info_loaded': (category) => `Text (${category}) loaded.`,
                'info_finished': 'üéâ Test finished! Your score has been saved.', // Ge√§ndert
                'alert_paste_blocked': '‚ùå Pasting is not allowed in the test!',
                'leaderboard_title': 'üèÜ Local Leaderboard (Top 10)', // NEU
                'lb_rank': 'Rank', 'lb_wpm': 'WPM', 'lb_acc': 'Accuracy', 'lb_diff': 'Category', 'lb_date': 'Date', // NEU
                'sampleTexts': {
                    short: ["HTML, CSS, and JavaScript form the foundation of the modern World Wide Web. HTML for structure, CSS for design, and JavaScript for interactivity and logic.", "The best way to improve typing speed is daily focus on accuracy and avoiding mistakes, rather than just focusing on pure speed."],
                    long: ["Learning to program is like learning a new language. It requires patience, practice, and understanding basic rules to eventually build complex applications that users will love.", "Continuous integration and continuous delivery are modern software development practices aiming to accelerate the release process while minimizing the error rate, which is essential for large teams."],
                    tech: ["function greet(name) { console.log(`Hello, ${name}!`); } greet('World'); // The function is called.", "if (x === true && y != 0) { return x / (y * 2); } else { throw new Error('Invalid input'); }"]
                }
            },
            // ... (F√ºgen Sie hier die √úbersetzungen f√ºr FR, ES, IT ein, inklusive der neuen 'leaderboard_title' und 'lb_' Keys) ...
            'fr': {
                'app_title': 'Entra√Æneur de Vitesse de Frappe',
                'title': 'üöÄ D√©fi de Dactylographie',
                'language_label': 'Langue:',
                'category_label': 'Cat√©gorie de Texte:',
                'category_short': 'Court & Facile',
                'category_long': 'Long & Complexe',
                'category_tech': 'Technique/Code',
                'wpm': 'MPM', 'accuracy': 'Pr√©cision', 'time': 'Temps',
                'placeholder': 'Commencez √† taper ici...',
                'new_text': 'Nouveau Texte / Red√©marrer',
                'info_ready': 'Pr√™t √† commencer !',
                'info_loaded': (category) => `Texte (${category}) charg√©.`,
                'info_finished': 'üéâ Test termin√© ! Votre score a √©t√© enregistr√©.',
                'alert_paste_blocked': '‚ùå Le collage (Coller) n\'est pas autoris√© dans le test !',
                'leaderboard_title': 'üèÜ Classement Local (Top 10)',
                'lb_rank': 'Rang', 'lb_wpm': 'MPM', 'lb_acc': 'Pr√©cision', 'lb_diff': 'Cat√©gorie', 'lb_date': 'Date',
                'sampleTexts': {
                    short: ["HTML, CSS et JavaScript forment la base du World Wide Web moderne. HTML pour la structure, CSS pour le design et JavaScript pour l'interactivit√© et la logique.", "La meilleure fa√ßon d'am√©liorer la vitesse de frappe est de se concentrer quotidiennement sur la pr√©cision et d'√©viter les erreurs, plut√¥t que sur la vitesse pure."],
                    long: ["Apprendre √† programmer, c'est comme apprendre une nouvelle langue. Cela demande de la patience, de la pratique et la compr√©hension des r√®gles de base pour pouvoir construire des applications complexes.", "L'int√©gration et la livraison continues sont des pratiques de d√©veloppement logiciel modernes visant √† acc√©l√©rer le processus de publication tout en minimisant le taux d'erreur, ce qui est essentiel pour les grandes √©quipes."],
                    tech: ["function saluer(nom) { console.log(`Bonjour, ${nom} !`); } saluer('Monde'); // La fonction est appel√©e.", "if (x === vrai && y != 0) { return x / (y * 2); } else { throw new Error('Entr√©e invalide'); }"]
                }
            },
            'es': {
                'app_title': 'Entrenador de Velocidad de Escritura',
                'title': 'üöÄ Desaf√≠o de Tipograf√≠a',
                'language_label': 'Idioma:',
                'category_label': 'Categor√≠a de Texto:',
                'category_short': 'Corto y F√°cil',
                'category_long': 'Largo y Complejo',
                'category_tech': 'T√©cnico/C√≥digo',
                'wpm': 'PPM', 'accuracy': 'Precisi√≥n', 'time': 'Tiempo',
                'placeholder': 'Empiece a escribir aqu√≠...',
                'new_text': 'Nuevo Texto / Reiniciar',
                'info_ready': '¬°Listo para empezar!',
                'info_loaded': (category) => `Texto (${category}) cargado.`,
                'info_finished': 'üéâ ¬°Prueba terminada! Tu puntuaci√≥n ha sido guardada.',
                'alert_paste_blocked': '‚ùå ¬°Pegar no est√° permitido en la prueba!',
                'leaderboard_title': 'üèÜ Clasificaci√≥n Local (Top 10)',
                'lb_rank': 'Puesto', 'lb_wpm': 'PPM', 'lb_acc': 'Precisi√≥n', 'lb_diff': 'Categor√≠a', 'lb_date': 'Fecha',
                'sampleTexts': {
                    short: ["HTML, CSS y JavaScript forman la base de la World Wide Web moderna. HTML para la estructura, CSS para el dise√±o y JavaScript para la interactividad y l√≥gica.", "La mejor manera de mejorar la velocidad de escritura es la concentraci√≥n diaria en la precisi√≥n y evitar errores, en lugar de centrarse solo en la velocidad pura."],
                    long: ["Aprender a programar es como aprender un nuevo idioma. Requiere paciencia, pr√°ctica y comprensi√≥n de las reglas b√°sicas para construir aplicaciones complejas que gustar√°n a los usuarios.", "La integraci√≥n continua y la entrega continua son pr√°cticas modernas de desarrollo de software que buscan acelerar el proceso de lanzamiento de software minimizando la tasa de error, esencial para grandes equipos."],
                    tech: ["function saludar(nombre) { console.log(`Hola, ${nombre}!`); } saludar('Mundo'); // La funci√≥n es llamada.", "if (x === verdadero && y != 0) { return x / (y * 2); } else { throw new Error('Entrada inv√°lida'); }"]
                }
            },
            'it': {
                'app_title': 'Trainer di Velocit√† di Battitura',
                'title': 'üöÄ Sfida di Battitura',
                'language_label': 'Lingua:',
                'category_label': 'Categoria Testo:',
                'category_short': 'Breve e Facile',
                'category_long': 'Lungo e Complesso',
                'category_tech': 'Tecnico/Codice',
                'wpm': 'PPM', 'accuracy': 'Precisione', 'time': 'Tempo',
                'placeholder': 'Inizia a digitare qui...',
                'new_text': 'Nuovo Testo / Riavvia',
                'info_ready': 'Pronto per iniziare!',
                'info_loaded': (category) => `Testo (${category}) caricato.`,
                'info_finished': 'üéâ Test terminato! Il tuo punteggio √® stato salvato.',
                'alert_paste_blocked': '‚ùå Incollare non √® consentito nel test!',
                'leaderboard_title': 'üèÜ Classifica Locale (Top 10)',
                'lb_rank': 'Posizione', 'lb_wpm': 'PPM', 'lb_acc': 'Precisione', 'lb_diff': 'Categoria', 'lb_date': 'Data',
                'sampleTexts': {
                    short: ["HTML, CSS e JavaScript costituiscono le fondamenta del World Wide Web moderno. HTML per la struttura, CSS per il design e JavaScript per l'interattivit√† e la logica.", "Il modo migliore per migliorare la velocit√† di battitura √® la concentrazione quotidiana sulla precisione e l'evitare errori, piuttosto che concentrarsi sulla velocit√† pura."],
                    long: ["Imparare a programmare √® come imparare una nuova lingua. Richiede pazienza, pratica e comprensione delle regole di base per costruire applicazioni complesse che piaceranno agli utenti.", "L'integrazione continua e la consegna continua sono pratiche di sviluppo software moderno volte ad accelerare il processo di rilascio minimizzando il tasso di errore, essenziale per i grandi team."],
                    tech: ["function saluta(nome) { console.log(`Ciao, ${nome}!`); } saluta('Mondo'); // La funzione viene chiamata.", "if (x === vero && y != 0) { return x / (y * 2); } else { throw new Error('Input non valido'); }"]
                }
            }
        };


        let currentText = '';
        let startTime = 0;
        let correctTypedCharacters = 0; 
        let totalTypedCharacters = 0;   
        let errorsMadeCount = 0;        
        let isRunning = false;


        // --- Internationalisierung und UI-Update (Unver√§ndert) ---

        function getPreferredLanguage() {
            const browserLang = (navigator.language || navigator.userLanguage).substring(0, 2);
            if (translations[browserLang]) {
                return browserLang;
            }
            return 'en'; 
        }

        function loadLanguage(langCode) {
            currentLang = langCode;
            const langData = translations[langCode] || translations['en']; 
            
            document.querySelectorAll('[data-translate-key]').forEach(element => {
                const key = element.getAttribute('data-translate-key');
                const translation = langData[key];

                if (translation) {
                    if (element.tagName === 'INPUT' && element.hasAttribute('placeholder')) {
                        element.setAttribute('placeholder', translation);
                    } else if (element.tagName === 'TITLE') {
                        document.title = translation;
                    } else if (element.tagName === 'OPTION') {
                        // Da OPTIONS auch als Kategorie-Beschriftung dienen
                        element.textContent = translation; 
                    } else if (typeof translation === 'string') {
                        element.textContent = translation;
                    }
                }
            });

            // Setze die Auswahl und rendere Leaderboard neu (wegen √ºbersetzter Spaltennamen)
            languageSelect.value = langCode;
            renderLeaderboard(); 
            startTest();
        }

        // --- Leaderboard Funktionen NEU ---

        function loadLeaderboard() {
            // Holt die gespeicherten Scores oder ein leeres Array
            const scores = localStorage.getItem('typingScores');
            return scores ? JSON.parse(scores) : [];
        }

        function saveScore(wpm, accuracy, difficulty) {
            const scores = loadLeaderboard();
            const date = new Date().toLocaleDateString(currentLang);
            const difficultyText = difficultySelect.options[difficultySelect.selectedIndex].textContent;
            
            // F√ºge neuen Score hinzu
            scores.push({ wpm, accuracy, difficulty: difficultyText, date });

            // Sortiere nach WPM (absteigend) und dann nach Genauigkeit (absteigend)
            scores.sort((a, b) => {
                if (b.wpm !== a.wpm) {
                    return b.wpm - a.wpm;
                }
                return b.accuracy - a.accuracy;
            });

            // Behalte nur die Top 10
            const topScores = scores.slice(0, 10);
            
            // Speichere zur√ºck in localStorage
            localStorage.setItem('typingScores', JSON.stringify(topScores));

            renderLeaderboard(wpm, accuracy);
        }
        
        function renderLeaderboard(newWpm = 0, newAccuracy = 0) {
            const scores = loadLeaderboard();
            const langData = translations[currentLang] || translations['en'];

            // Header-Zeile erstellen
            let html = `
                <thead>
                    <tr>
                        <th data-translate-key="lb_rank">${langData.lb_rank}</th>
                        <th data-translate-key="lb_wpm">${langData.lb_wpm}</th>
                        <th data-translate-key="lb_acc">${langData.lb_acc}</th>
                        <th data-translate-key="lb_diff">${langData.lb_diff}</th>
                        <th data-translate-key="lb_date">${langData.lb_date}</th>
                    </tr>
                </thead>
                <tbody>
            `;

            // Datenzeilen erstellen
            scores.forEach((score, index) => {
                const isNewScore = score.wpm === newWpm && score.accuracy === newAccuracy && index < 10;
                let rowClass = '';
                if (index === 0) rowClass = 'place-1';
                else if (index === 1) rowClass = 'place-2';
                else if (index === 2) rowClass = 'place-3';
                else if (isNewScore) rowClass = 'new-score-highlight'; // Optionales Highlighting

                html += `
                    <tr class="${rowClass}">
                        <td>${index + 1}</td>
                        <td>${score.wpm}</td>
                        <td>${score.accuracy}%</td>
                        <td>${score.difficulty}</td>
                        <td>${score.date}</td>
                    </tr>
                `;
            });
            
            html += `</tbody>`;
            leaderboardTable.innerHTML = html;
        }

        // --- Setup und Start ---
        
        function loadText() {
            const difficulty = difficultySelect.value;
            const langData = translations[currentLang] || translations['en'];
            const texts = langData.sampleTexts[difficulty];
            
            currentText = texts[Math.floor(Math.random() * texts.length)];
            textToTypeElement.innerHTML = '';

            currentText.split('').forEach((char) => {
                const charSpan = document.createElement('span');
                charSpan.textContent = char;
                textToTypeElement.appendChild(charSpan);
            });
            textToTypeElement.children[0].classList.add('current');
            
            const categoryText = difficultySelect.options[difficultySelect.selectedIndex].textContent;
            infoMessage.textContent = langData.info_loaded(categoryText);
        }

        function startTest() {
            clearInterval(timer);
            isRunning = false;
            startTime = 0;
            
            correctTypedCharacters = 0;
            totalTypedCharacters = 0;
            errorsMadeCount = 0;
            
            wpmDisplay.textContent = '0';
            accuracyDisplay.textContent = '0%';
            timeDisplay.textContent = '0.00s';
            
            inputField.value = '';
            inputField.disabled = false;
            inputField.focus();
            
            // Setze WPM/Genauigkeit auf 0 zur√ºck (wird durch loadLanguage / renderLeaderboard mit aufgerufen)
            updateMetrics(false); 

            loadText(); 
            // FIX: WPM-Update-Intervall neu starten
            timer = setInterval(() => {
                if (isRunning) updateMetrics(true); 
            }, 100); 
        }

        // --- Anti-Copy-Paste-Schutz (Unver√§ndert) ---
        inputField.addEventListener('paste', (e) => {
            e.preventDefault();
            const langData = translations[currentLang] || translations['en'];
            infoMessage.textContent = langData.alert_paste_blocked;
            setTimeout(() => {
                infoMessage.textContent = langData.info_loaded(difficultySelect.options[difficultySelect.selectedIndex].textContent);
            }, 1500);
        });

        inputField.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        inputField.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
                e.preventDefault();
                const langData = translations[currentLang] || translations['en'];
                infoMessage.textContent = langData.alert_paste_blocked;
                setTimeout(() => {
                    infoMessage.textContent = langData.info_loaded(difficultySelect.options[difficultySelect.selectedIndex].textContent);
                }, 1500);
            }
        });
        
        // --- Hauptlogik beim Tippen ---

        inputField.addEventListener('input', (e) => {
            if (!isRunning) {
                isRunning = true;
                startTime = Date.now();
                // Der Timer f√ºr WPM l√§uft jetzt schon, wird aber neu gestartet, wenn der Test startet (siehe startTest())
            }

            const input = inputField.value;
            const targetChars = textToTypeElement.children;
            const newLength = input.length;
            
            if (newLength > totalTypedCharacters) {
                const lastTypedIndex = newLength - 1;
                if (input[lastTypedIndex] !== currentText[lastTypedIndex]) {
                    errorsMadeCount++; 
                }
            }
            
            totalTypedCharacters = newLength; 
            correctTypedCharacters = 0; 

            for (let i = 0; i < currentText.length; i++) {
                const targetChar = currentText[i];
                const typedChar = input[i];
                const charElement = targetChars[i];

                charElement.classList.remove('current', 'correct', 'incorrect');
                
                if (i < newLength) {
                    if (typedChar === targetChar) {
                        charElement.classList.add('correct');
                        correctTypedCharacters++; 
                    } else {
                        charElement.classList.add('incorrect');
                    }
                } else if (i === newLength && i < currentText.length) {
                    charElement.classList.add('current');
                }
            }
            
            updateMetrics(false); 

            // --- Test beenden ---
            if (newLength === currentText.length) {
                inputField.disabled = true;
                clearInterval(timer);
                isRunning = false;
                
                const langData = translations[currentLang] || translations['en'];
                infoMessage.textContent = langData.info_finished; // NEU: Kein Alert

                // Speichere den Score und render das Leaderboard neu
                const finalAccuracy = parseInt(accuracyDisplay.textContent.replace('%', ''));
                const finalWPM = parseInt(wpmDisplay.textContent);
                const difficulty = difficultySelect.value;
                
                saveScore(finalWPM, finalAccuracy, difficulty);
            }
        });

        // --- Metriken Berechnung (Unver√§ndert) ---
        function updateMetrics(onlyTime = false) {
            // FIX: Pr√ºfe auf startTime > 0, um Division durch Null zu vermeiden
            if (startTime === 0) return;
            
            const timeElapsedInSeconds = (Date.now() - startTime) / 1000;
            
            timeDisplay.textContent = `${timeElapsedInSeconds.toFixed(2)}s`;

            if (onlyTime && !isRunning) return;

            if (totalTypedCharacters > 0 && timeElapsedInSeconds > 0) {
                const correctWords = correctTypedCharacters / 5;
                const minutes = timeElapsedInSeconds / 60;
                
                const wpm = Math.round(correctWords / minutes);
                
                const currentAccuracy = totalTypedCharacters > 0 
                    ? Math.round(((totalTypedCharacters - errorsMadeCount) / totalTypedCharacters) * 100)
                    : 0;

                wpmDisplay.textContent = wpm;
                accuracyDisplay.textContent = `${Math.max(0, currentAccuracy)}%`; 
            } else if (!onlyTime) {
                 wpmDisplay.textContent = '0';
                 accuracyDisplay.textContent = '0%';
            }
        }
        
        // --- Automatischer Start bei Seitenaufruf ---
        document.addEventListener('DOMContentLoaded', () => {
            const preferredLang = getPreferredLanguage();
            loadLanguage(preferredLang); 
            renderLeaderboard(); // Lade und zeige die gespeicherten Scores beim Start
        });
    </script>
</body>
</html>
